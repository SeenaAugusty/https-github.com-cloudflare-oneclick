
name: Deploy Worker

on:
  workflow_dispatch:
    inputs:
      cf_account_id:
        description: "Cloudflare Account ID"
        required: true
      cf_api_token:
        description: "Cloudflare API Token (Workers Scripts:Edit; add Zone perms if using routes)"
        required: true
      ingest_url:
        description: "Your ingestion HTTPS endpoint"
        required: true
      tenant_key:
        description: "Per-customer API key/token"
        required: true
      cf_route:
        description: "Optional route (e.g., example.com/ingest/*)"
        required: false
      cf_zone_id:
        description: "Zone ID (required if route is set)"
        required: false
  push:
    branches: [ main ]
    paths:
      - 'apps/worker/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/worker
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Publish Worker
        run: |
          npx wrangler deploy             --var INGEST_URL:${{ inputs.ingest_url || secrets.INGEST_URL }}             --var TENANT_KEY:${{ inputs.tenant_key || secrets.TENANT_KEY }}
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ inputs.cf_account_id || secrets.CF_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN:  ${{ inputs.cf_api_token  || secrets.CF_API_TOKEN  }}

      - name: Attach Route (optional)
        if: ${{ inputs.cf_route != '' }}
        run: |
          npx wrangler routes deploy             --route "${{ inputs.cf_route }}"             --zone-id "${{ inputs.cf_zone_id }}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ inputs.cf_account_id }}
          CLOUDFLARE_API_TOKEN:  ${{ inputs.cf_api_token  }}
